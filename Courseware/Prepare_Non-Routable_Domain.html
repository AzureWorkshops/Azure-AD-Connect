<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Prepare Non-Routable Domain - Azure AD Connect</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

    <meta name="description" content="Azure Workshops" />
    <meta name="author" content="Joshua Davis">
    <link rel="icon" href="" type="image/x-icon">
    
    <!-- Font -->
    
    <!-- CSS -->
    <link href='../themes/azure/css/vs.css' rel='stylesheet' type='text/css'><link href='../themes/azure/css/theme.css' rel='stylesheet' type='text/css'><link href='../themes/azure/css/theme-white.min.css' rel='stylesheet' type='text/css'>
</head>
<body class="">

        <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-2 col-md-offset-1">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="/">Azure Workshops</a>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                        <ul class="nav navbar-nav navbar-right">
                            <!--
                            <li><a href="about.html">About</a></li>
                            <li><a href="contact.html">Contact</a></li>
                            -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

<div id="content-wrapper" class="container-fluid">
    <div class="row hidden-print">
        <div class="col-md-10 col-md-offset-1 breadcrumbs">
            <a href="../index.html">Azure AD Connect</a> / <a href="../Courseware/Exploring_Azure.html">Courseware</a> / <a href="../Courseware/Prepare_Non-Routable_Domain.html">Prepare Non-Routable Domain</a>        </div>
    </div>
    <div class="row">
        <div class="col-md-2 col-md-offset-1 hidden-print">
            <div data-spy="affix" data-offset-top="100">
                <!-- Navigation -->
                <ul class='Nav'><li class='Nav__item '><a href="../Overview.html">Overview</a></li><li class='Nav__item  has-children'><a href="#" class="aj-nav folder"><i class="Nav__arrow">&nbsp;</i>Getting Started</a><ul class='Nav'><li class='Nav__item '><a href="../Getting_Started/Requirements.html">Requirements</a></li><li class='Nav__item '><a href="../Getting_Started/Office_365_and_Azure_Registration.html">Office 365 and Azure Registration</a></li><li class='Nav__item '><a href="../Getting_Started/Setup.html">Setup</a></li></ul></li><li class='Nav__item Nav__item--open has-children'><a href="#" class="aj-nav folder"><i class="Nav__arrow">&nbsp;</i>Courseware</a><ul class='Nav'><li class='Nav__item '><a href="../Courseware/Exploring_Azure.html">Exploring Azure</a></li><li class='Nav__item '><a href="../Courseware/Create_Connect_Server.html">Create Connect Server</a></li><li class='Nav__item '><a href="../Courseware/View_Azure_Domain.html">View Azure Domain</a></li><li class='Nav__item Nav__item--active'><a href="../Courseware/Prepare_Non-Routable_Domain.html">Prepare Non-Routable Domain</a></li><li class='Nav__item '><a href="../Courseware/Installing_Azure_AD_Connect.html">Installing Azure AD Connect</a></li><li class='Nav__item '><a href="../Courseware/Monitoring_Health.html">Monitoring Health</a></li></ul></li></ul>
                <div class="Links">
                    
                    <div class="pdf-link">
                        <hr />
                        <a href="../pdf/Azure AD Connect.pdf"><i class="fa fa-file-pdf-o" aria-hidden="true"></i> <span>Download PDF</span></a>
                    </div>

                                            <hr/>
                        <div class="Twitter">
                                                            <iframe allowtransparency="true" frameborder="0" scrolling="no" style="width:162px; height:20px;" src="https://platform.twitter.com/widgets/follow_button.html?screen_name=azureworkshops&amp;show_count=false"></iframe>
                                <br />
                                <br />
                                                    </div>
                                    </div>
            </div>
        </div>
        <div class="col-md-6">
            <article class="Page">
    <div class="pageHeader">
        <h1>Prepare Non-Routable Domain</h1>
                    <div class="date"> Friday, August 4, 2017 7:45 AM</div>
            </div>
    <div class="copy">
        <h2 id="page_Objective">Objective</h2>
<p>In typical on-premises installations of Active Directory, utilized domain name extensions, such as &quot;.local&quot;, create what are known as <em>non-routable domains</em>.  In other words, there's no such top-level domain (TLD) extension.  In the words of Microsoft's support:</p>
<div class="bs-callout bs-callout-primary"><h4>Synchronization</h4>Azure AD Connect only synchronizes users to domains that are verified by Office 365. This means that the domain also is verified by Azure Active Directory because Office 365 identities are managed by Azure Active Directory. In other words, the domain has to be a valid Internet domain (for example, .com, .org, .net, .us, etc.). If your internal Active Directory only uses a non-routable domain (for example, .local), this can't possibly match the verified domain you have on Office 365.</div>

<p>The objective for this step is to modify our local domain to create a routable domain.  We will then update the UPN of our users to take advantage of this new domain.</p>
<h2 id="page_Add-UPN-Suffixes">Add UPN Suffixes</h2>
<p>We will need to remotely connect to <strong>dc1</strong> in order to update Active Directory. Because <strong>dc1</strong> is not accessible from outside of the network, we'll need to connect to it through the <strong>utility</strong> virtual machine.</p>
<h3 id="page_Enable-the-AD-DS-Snap-In">Enable the AD DS Snap-In</h3>
<p>By default, the machines do not include the Active Directory management snap-in.  For easier management, let's go ahead and enable it.</p>
<ol>
<li>
<p>Go ahead and RDP into the <strong>utility</strong> virtual machine.  Once connected to the <strong>utility</strong> VM, RDP into <strong>dc1</strong>.  You can connect to <strong>dc1</strong> by using it's DNS hostname (e.g. &quot;dc1&quot;) or it's IP address, 10.3.1.4.</p>
</li>
<li>
<p>Once connected to <strong>dc1</strong>, <em>Server Manager</em> should automatically open. If it doesn't, go ahead and open it now.</p>
</li>
<li>
<p>In the top-right of <em>Server Manager</em>, click on <strong>Manage</strong>.  Then, click on <strong>Add Roles and Features</strong>.</p>
</li>
<li>
<p>In the &quot;Before you begin&quot; screen, click &quot;Next.&quot;</p>
</li>
<li>
<p>Make sure &quot;Role-based or feature-based installation&quot; is selected, then click &quot;Next.&quot;</p>
</li>
<li>
<p>For the destination server, your local domain controller should be highlighted.  Click &quot;Next.&quot;</p>
</li>
<li>
<p>We don't need to add any additional roles at this point, so just click &quot;Next.&quot;</p>
</li>
<li>
<p>For features, we need to add two features. You can install both by selecting:  <strong>Remote Server Administration Tools &gt; Role Administration Tools &gt; AD DS and AD LDS Tools &gt; AD DS Tools</strong>. This will add the AD Domain Services snap-in and command-line tools.</p>
</li>
<li>
<p>Click &quot;Next.&quot;</p>
</li>
<li>
<p>Finally, click &quot;Install.&quot;</p>
</li>
</ol>
<p>This should only take a minute or two to complete.  You can click &quot;Close&quot; when the process has completed.</p>
<h3 id="page_Add-Suffix-to-AD-Domains-and-Trusts">Add Suffix to AD Domains and Trusts</h3>
<p>With the snap-in installed, we can easily add the UPN suffix to our Active Directory.</p>
<ol>
<li>
<p>If it's not still open, launch <em>Server Manager</em>.</p>
</li>
<li>
<p>In the top-right of <em>Server Manager</em>, click on <strong>Tools</strong>.  Then, click on <strong>Active Directory Domains and Trusts</strong>.</p>
</li>
<li>
<p>In the <em>Active Directory Domains and Trusts</em> window, right-click <strong>Active Directory Domains and Trusts</strong> in the left pane, and then choose &quot;Properties.&quot;</p>
</li>
<li>
<p>In the <em>Alternative UPN suffixes</em> box, enter your full domain of your Office 365 tenant (e.g. <em>&lt;yourcompany&gt;</em>.onmicrosoft.com). Click &quot;Add.&quot;</p>
</li>
<li>
<p>Click &quot;OK.&quot;</p>
</li>
</ol>
<h3 id="page_Change-the-UPN-suffix-for-existing-users">Change the UPN suffix for existing users</h3>
<p>Now that we've added an alternative UPN to our domain, we need to update each of our users to use this domain as the <em>primary</em> UPN as that is what Azure AD Connect uses to match identities.</p>
<ol>
<li>
<p>Again, if it's not still open, launch <em>Server Manager</em>.</p>
</li>
<li>
<p>In the top-right of <em>Server Manager</em>, click on <strong>Tools</strong>.  Then, click on <strong>Active Directory Users and Computers</strong>.</p>
</li>
<li>
<p>In the <em>Active Directory Users and Computers</em> window, expand your &quot;.local&quot; domain and click on <strong>Users</strong>.</p>
</li>
<li>
<p>There are 3 user accounts for which we need to update the UPN (NOTE: We do not want to sync the local <em>cloudadmin</em> enterprise administrator account to the cloud in order to preserve boundaries.  You should utilize a separate account in Azure for administering Azure AD.)</p>
<ul>
<li>Jim Smith</li>
<li>Richard Jackson</li>
<li>Sally Holly</li>
</ul>
</li>
<li>
<p>For each of these accounts, righ-click on the account and choose <strong>Properties</strong>.</p>
</li>
<li>
<p>Click on the <strong>Account</strong> tab.</p>
</li>
<li>
<p>In the dropdown list next to the username, change the selection from your local domain to the &quot;onmicrosoft.com&quot; domain.  Click &quot;OK.&quot;</p>
</li>
</ol>
<p>Congratulations! Your local Active Directory is now ready to begin basic synchronization with Azure AD.</p>
<p>One thing to keep in mind is that updating the UPN in the last step now requires these three users to use the FQDN of the <em>onmicrosoft.com</em> account rather than the <em>.local</em> domain if they use the <em>first.last@domain.local</em> format for the username.  However, most users don't login using a FQDN.  Instead they, like what we've done in this workshop, use the pre-Windows 2000 method of specifying the username (e.g. MYCOMPANY\first.last).  Not too big of a deal, but, again, just something to make note of.</p>
<p>Finally, if you have a lot of users in your domain, manually updating the UPN domain for each user can be a tedious task. Luckily for us, here's a PowerShell script for that:</p>
<pre><code class="language-PS">$LocalUsers = Get-ADUser -Filter {UserPrincipalName -like '*mycompany.local'} -Properties userPrincipalName -ResultSetSize $null

$LocalUsers | foreach {$newUpn = $_.UserPrincipalName.Replace(&quot;mycompany.local&quot;,&quot;mycompany.onmicrosoft.com&quot;); $_ | Set-ADUser -UserPrincipalName $newUpn}
</code></pre>
    </div>

            <nav class="hidden-print">
            <ul class="pager">
                                    <li class=pager-prev><a href="../Courseware/View_Azure_Domain.html">Previous</a></li>
                                                    <li class=pager-next><a href="../Courseware/Installing_Azure_AD_Connect.html">Next</a></li>            </ul>
        </nav>
    </article>
        </div>
        <div class="col-md-2 hidden-print">
            <div class="article-links" data-spy="affix" data-offset-top="100">
                <strong>In this article</strong><ol><li><a href="#page_Objective">Objective</a></li><li><a href="#page_Add-UPN-Suffixes">Add UPN Suffixes</a></li></ol>
            </div>
        </div>
    </div>
</div>

    <div id="footer" class="container-fluid hidden-print">
        <div class="row">
            <div class="col-md-2 col-md-offset-1">
            
            </div>
            <div class="col-md-8" style="text-align:right;">
            This work is licensed under a Creative Commons Attribution 4.0 International License.
            </div>
        </div>
    </div>
    
    <script src="//ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <!-- JS -->
    
    <script src="../themes/azure/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <script src="../themes/azure/js/theme.js"></script>

</body>
</html>
